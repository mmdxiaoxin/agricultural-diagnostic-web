server {
  listen 80;
  server_name www.binghai-zhenduan.com www.mmdxiaoxin.top;

  # 将 HTTP 请求重定向到 HTTPS
  return 301 https://$server_name$request_uri;
}

# 病害诊断系统 HTTPS 配置
server {
  # 监听配置
  listen 443 ssl;
  listen [::]:443 ssl;

  # 启用 HTTP/2
  http2 on;
  server_name www.binghai-zhenduan.com;

  # SSL 证书配置
  ssl_certificate /www/server/nginx/ssl/certs/127.0.0.1+1.pem;
  ssl_certificate_key /www/server/nginx/ssl/private/127.0.0.1+1-key.pem;

  # SSL 优化配置
  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:50m;
  ssl_session_tickets off;

  # 现代 SSL 配置
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
  ssl_prefer_server_ciphers off;

  # HSTS 配置
  add_header Strict-Transport-Security "max-age=63072000" always;

  # 启用 ETag
  etag on;

  # 启用 gzip 压缩（适用于动态内容）
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml+rss text/javascript;
  gzip_vary on;
  gzip_comp_level 6;
  gzip_min_length 1024;
  gzip_buffers 16 8k;
  gzip_disable "msie6";

  # 前端静态资源
  location / {
    root /var/www/agricultural-diagnostic-web;
    index index.html;
    try_files $uri $uri/ /index.html;

    # 针对 index.html 的特殊处理
    location = /index.html {
      expires -1; # 不设置过期时间
      add_header Cache-Control "no-cache, must-revalidate";
      add_header ETag $request_filename;
      add_header X-Content-Type-Options "nosniff";
    }
  }

  # 处理静态资源
  location ~* \.(js|css)$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";
  }

  # 处理图片资源
  location ~* \.(jpg|jpeg|png|gif|ico|svg)$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff";
  }

  # 处理字体文件
  location ~* \.(ttf|woff|woff2|eot)$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Access-Control-Allow-Origin "*";
    add_header X-Content-Type-Options "nosniff";
  }

  # 处理 JSON 文件
  location ~* \.json$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
    add_header X-Content-Type-Options "nosniff";
  }

  # 平台服务代理
  location /api/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    client_max_body_size 6M; # 设置上传文件大小限制为 6MB
  }

  # AI 服务代理
  location /ai/ {
    proxy_pass http://127.0.0.1:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}

# 小新网站 HTTPS 配置
server {
  # 监听配置
  listen 443 ssl;
  listen [::]:443 ssl;

  # 启用 HTTP/2
  http2 on;
  server_name www.mmdxiaoxin.top;

  # SSL 证书配置
  ssl_certificate /www/server/nginx/ssl/certs/full_chain_mmdxiaoxin.top.crt;
  ssl_certificate_key /www/server/nginx/ssl/private/mmdxiaoxin.top.key;

  # SSL 优化配置
  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:50m;
  ssl_session_tickets off;

  # 现代 SSL 配置
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
  ssl_prefer_server_ciphers off;

  # HSTS 配置
  add_header Strict-Transport-Security "max-age=63072000" always;

  # 启用 OCSP Stapling
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate /www/server/nginx/ssl/certs/ca_mmdxiaoxin.top.crt;

  # 启用 ETag
  etag on;

  # 启用 gzip 压缩（适用于动态内容）
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml+rss text/javascript;
  gzip_vary on;
  gzip_comp_level 6;
  gzip_min_length 1024;
  gzip_buffers 16 8k;
  gzip_disable "msie6";

  # 前端静态资源
  location / {
    root /var/www/agricultural-diagnostic-web;
    index index.html;
    try_files $uri $uri/ /index.html;

    # 针对 index.html 的特殊处理
    location = /index.html {
      expires -1; # 不设置过期时间
      add_header Cache-Control "no-cache, must-revalidate";
      add_header ETag $request_filename;
      add_header X-Content-Type-Options "nosniff";
    }
  }

  # 处理静态资源
  location ~* \.(js|css)$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";
  }

  # 处理图片资源
  location ~* \.(jpg|jpeg|png|gif|ico|svg)$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff";
  }

  # 处理字体文件
  location ~* \.(ttf|woff|woff2|eot)$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Access-Control-Allow-Origin "*";
    add_header X-Content-Type-Options "nosniff";
  }

  # 处理 JSON 文件
  location ~* \.json$ {
    root /var/www/agricultural-diagnostic-web;
    gzip_static on;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
    add_header X-Content-Type-Options "nosniff";
  }

  # 平台服务代理
  location /api/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    client_max_body_size 6M; # 设置上传文件大小限制为 6MB
  }

  # AI 服务代理
  location /ai/ {
    proxy_pass http://127.0.0.1:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}